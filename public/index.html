<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Terminal</title>
  <script src="https://web.squarecdn.com/v1/square.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f4f5f7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Login screen */
    #login-screen {
      display: none;
      position: fixed; inset: 0;
      background: #f4f5f7;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    #login-screen.visible { display: flex; }
    .login-box {
      background: white; border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.12);
      padding: 40px 36px; width: 100%; max-width: 360px;
      text-align: center;
    }
    .login-logo { font-size: 40px; margin-bottom: 12px; }
    .login-title { font-size: 22px; font-weight: 700; color: #111827; margin-bottom: 6px; }
    .login-sub { font-size: 14px; color: #6b7280; margin-bottom: 28px; }
    .login-field { margin-bottom: 16px; text-align: left; }
    .login-field label { font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px; }
    .login-field input {
      width: 100%; padding: 12px 14px; border: 1px solid #d1d5db;
      border-radius: 10px; font-size: 15px; outline: none; transition: border 0.2s;
    }
    .login-field input:focus { border-color: #006AFF; }
    .login-field input.error { border-color: #ef4444; }
    .login-error { color: #ef4444; font-size: 13px; margin-bottom: 12px; display: none; }
    .btn-login {
      width: 100%; padding: 14px; background: #006AFF; color: white;
      border: none; border-radius: 10px; font-size: 15px; font-weight: 600;
      cursor: pointer; transition: background 0.2s;
    }
    .btn-login:hover { background: #0057d4; }
    .btn-login:disabled { background: #93c5fd; cursor: not-allowed; }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      width: 100%;
      max-width: 480px;
      overflow: hidden;
    }
    .header {
      background: #006AFF;
      color: white;
      padding: 20px 28px;
    }
    .header h1 { font-size: 20px; font-weight: 600; }
    .header p { font-size: 12px; opacity: 0.8; margin-top: 3px; }
    .profile-bar {
      display: flex; align-items: center; gap: 8px;
      margin-top: 12px; background: rgba(255,255,255,0.15);
      border-radius: 8px; padding: 8px 12px;
    }
    .profile-bar label { font-size: 12px; color: rgba(255,255,255,0.8); white-space: nowrap; }
    .profile-select {
      flex: 1; background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3); border-radius: 6px;
      color: white; font-size: 14px; font-weight: 600;
      padding: 5px 8px; cursor: pointer; outline: none;
    }
    .profile-select option { background: #1d4ed8; color: white; }
    .profile-limit {
      font-size: 11px; color: rgba(255,255,255,0.7);
      margin-top: 5px; padding-left: 2px;
    }
    .tabs {
      display: flex; border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
    }
    .tab {
      flex: 1; padding: 12px 6px; text-align: center;
      font-size: 12px; font-weight: 500; cursor: pointer;
      color: #6b7280; border-bottom: 2px solid transparent;
      transition: all 0.2s; white-space: nowrap; min-width: 70px;
    }
    .tab.active { color: #006AFF; border-bottom-color: #006AFF; }
    .panel { display: none; padding: 20px 24px; max-height: 70vh; overflow-y: auto; }
    .panel.active { display: block; }
    .field { margin-bottom: 14px; }
    label {
      display: block; font-size: 13px; font-weight: 500;
      color: #374151; margin-bottom: 5px;
    }
    label .req { color: #ef4444; margin-left: 2px; }
    input[type="text"], input[type="number"], input[type="email"],
    input[type="password"], select, textarea {
      width: 100%; padding: 10px 12px;
      border: 1px solid #d1d5db; border-radius: 8px;
      font-size: 14px; outline: none; transition: border 0.2s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus { border-color: #006AFF; }
    input.error, textarea.error { border-color: #ef4444; }
    .field-error { font-size: 11px; color: #ef4444; margin-top: 3px; }
    .amount-wrap { position: relative; }
    .amount-wrap span {
      position: absolute; left: 12px; top: 50%;
      transform: translateY(-50%); color: #6b7280; font-size: 14px;
    }
    .amount-wrap input { padding-left: 24px; }
    #card-container {
      border: 1px solid #d1d5db; border-radius: 8px;
      padding: 10px 12px; min-height: 44px;
    }
    .btn {
      width: 100%; padding: 13px; border: none; border-radius: 8px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      transition: background 0.2s; margin-top: 8px;
    }
    .btn-primary { background: #006AFF; color: white; }
    .btn-primary:hover { background: #0057d4; }
    .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }
    .btn-green { background: #10b981; color: white; }
    .btn-green:hover { background: #059669; }
    .btn-green:disabled { background: #6ee7b7; cursor: not-allowed; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { width: auto; padding: 6px 12px; font-size: 12px; margin-top: 0; }
    .result {
      margin-top: 14px; padding: 13px; border-radius: 8px;
      font-size: 14px; display: none; line-height: 1.5;
    }
    .result.success { background: #ecfdf5; color: #065f46; border: 1px solid #6ee7b7; }
    .result.error { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }
    .result.warn { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }
    .link-box { display: flex; gap: 8px; margin-top: 10px; }
    .link-box input { flex: 1; background: #f9fafb; font-size: 13px; }
    .btn-copy {
      padding: 10px 14px; background: #006AFF; color: white;
      border: none; border-radius: 8px; cursor: pointer;
      font-size: 13px; font-weight: 600; white-space: nowrap;
    }
    .btn-copy:hover { background: #0057d4; }
    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
      border-radius: 50%; animation: spin 0.7s linear infinite;
      vertical-align: middle; margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* History */
    .tx-list { }
    .tx-item {
      padding: 10px 12px; border: 1px solid #e5e7eb;
      border-radius: 8px; margin-bottom: 8px; font-size: 13px;
    }
    .tx-item.failed { border-color: #fca5a5; background: #fef2f2; }
    .tx-item.link-created { border-color: #a7f3d0; background: #ecfdf5; }
    .tx-row { display: flex; justify-content: space-between; align-items: center; }
    .tx-amount { font-size: 15px; font-weight: 700; color: #111827; }
    .tx-badge {
      font-size: 11px; padding: 2px 8px; border-radius: 20px;
      font-weight: 600;
    }
    .badge-ok { background: #d1fae5; color: #065f46; }
    .badge-fail { background: #fee2e2; color: #991b1b; }
    .badge-link { background: #dbeafe; color: #1e40af; }
    .tx-note { color: #6b7280; margin-top: 3px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tx-date { color: #9ca3af; font-size: 11px; margin-top: 2px; }
    .tx-receipt { font-size: 12px; color: #006AFF; text-decoration: none; }
    .tx-receipt:hover { text-decoration: underline; }
    .empty-state { text-align: center; color: #9ca3af; padding: 40px 0; font-size: 14px; }

    /* Settings */
    .profile-list { margin-bottom: 20px; }
    .profile-card {
      border: 1px solid #e5e7eb; border-radius: 8px;
      margin-bottom: 8px; overflow: hidden;
    }
    .profile-card.is-active { border-color: #006AFF; }
    .profile-card-header {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 12px; background: #f9fafb;
    }
    .profile-card.is-active .profile-card-header { background: #eff6ff; }
    .profile-card-name { flex: 1; font-size: 14px; font-weight: 600; color: #111827; }
    .profile-card-sub { font-size: 11px; color: #6b7280; }
    .badge-active { font-size: 11px; background: #006AFF; color: white; padding: 2px 8px; border-radius: 20px; }
    .profile-card-actions { display: flex; gap: 6px; padding: 8px 12px; border-top: 1px solid #e5e7eb; }
    .merchant-info {
      padding: 10px 12px; border-top: 1px solid #e5e7eb;
      background: #f9fafb; font-size: 12px;
    }
    .merchant-info.loading { color: #9ca3af; font-style: italic; }
    .merchant-info.error-state { color: #ef4444; }
    .merchant-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 6px 16px; margin-top: 4px;
    }
    .merchant-field label { color: #9ca3af; font-size: 11px; display: block; }
    .merchant-field span { color: #111827; font-weight: 500; font-size: 12px; }
    .status-dot {
      display: inline-block; width: 7px; height: 7px;
      border-radius: 50%; margin-right: 4px;
    }
    .status-dot.active { background: #10b981; }
    .status-dot.inactive { background: #ef4444; }

    /* Report */
    .report-toolbar { margin-bottom: 16px; }
    .period-btns { display: flex; gap: 6px; flex-wrap: wrap; }
    .period-btn {
      padding: 6px 14px; border: 1px solid #d1d5db; border-radius: 20px;
      background: white; font-size: 13px; font-weight: 500; cursor: pointer;
      color: #374151; transition: all 0.15s;
    }
    .period-btn.active { background: #006AFF; color: white; border-color: #006AFF; }
    .period-btn:hover:not(.active) { border-color: #006AFF; color: #006AFF; }
    .report-totals {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 8px; margin-bottom: 16px;
    }
    .report-total-card {
      background: #f9fafb; border: 1px solid #e5e7eb;
      border-radius: 8px; padding: 12px 14px;
    }
    .report-total-card.highlight { background: #eff6ff; border-color: #93c5fd; }
    .report-total-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; }
    .report-total-value { font-size: 20px; font-weight: 700; color: #111827; }
    .report-total-card.highlight .report-total-value { color: #006AFF; }
    .report-loc-card {
      border: 1px solid #e5e7eb; border-radius: 8px;
      margin-bottom: 10px; overflow: hidden;
    }
    .report-loc-card.is-current { border-color: #006AFF; }
    .report-loc-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 13px; background: #f9fafb; cursor: pointer;
    }
    .report-loc-card.is-current .report-loc-header { background: #eff6ff; }
    .report-loc-name { font-size: 14px; font-weight: 600; color: #111827; }
    .report-loc-total { font-size: 16px; font-weight: 700; color: #006AFF; }
    .report-loc-body {
      display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
      border-top: 1px solid #e5e7eb;
    }
    .report-stat {
      padding: 8px 10px; text-align: center;
      border-right: 1px solid #e5e7eb; font-size: 12px;
    }
    .report-stat:last-child { border-right: none; }
    .report-stat-val { font-weight: 700; color: #111827; font-size: 13px; }
    .report-stat-lbl { color: #9ca3af; font-size: 10px; margin-top: 1px; }
    .report-inactive { color: #9ca3af; font-size: 12px; font-style: italic; }

    /* Locations */
    .loc-card {
      border: 1px solid #e5e7eb; border-radius: 8px;
      margin-bottom: 10px; overflow: hidden;
    }
    .loc-card.loc-active { border-color: #006AFF; }
    .loc-header {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 11px 13px; background: #f9fafb;
    }
    .loc-card.loc-active .loc-header { background: #eff6ff; }
    .loc-name { font-size: 14px; font-weight: 700; color: #111827; }
    .loc-addr { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .loc-status-badge {
      font-size: 11px; padding: 2px 8px; border-radius: 20px; white-space: nowrap;
    }
    .loc-status-active { background: #d1fae5; color: #065f46; }
    .loc-status-inactive { background: #fee2e2; color: #991b1b; }
    .loc-stats {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      border-top: 1px solid #e5e7eb;
    }
    .loc-stat {
      padding: 9px 13px; text-align: center;
      border-right: 1px solid #e5e7eb;
    }
    .loc-stat:last-child { border-right: none; }
    .loc-stat-value { font-size: 15px; font-weight: 700; color: #111827; }
    .loc-stat-label { font-size: 10px; color: #9ca3af; margin-top: 1px; }

    .divider { border: none; border-top: 1px solid #e5e7eb; margin: 18px 0; }
    .section-title { font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .hint { font-size: 11px; color: #9ca3af; margin-top: 3px; }
    .row { display: flex; gap: 10px; }
    .row .field { flex: 1; }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" class="visible">
  <div class="login-box">
    <div class="login-logo">üí≥</div>
    <div class="login-title">Payment Terminal</div>
    <div class="login-sub">Enter your password to continue</div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        onkeydown="if(event.key==='Enter') doLogin()" />
    </div>
    <div class="login-error" id="login-error">Incorrect password</div>
    <button class="btn-login" id="btn-login" onclick="doLogin()">Sign In</button>
  </div>
</div>

<!-- MAIN APP -->
<div class="container" id="app" style="display:none">
  <div class="header">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <h1>üí≥ Payment Terminal</h1>
        <p>Manual entry or send payment link</p>
      </div>
      <button onclick="doLogout()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px">Sign Out</button>
    </div>
    <div class="profile-bar">
      <label>Business:</label>
      <select class="profile-select" id="profile-switcher" onchange="switchProfile(this.value)">
        <option>Loading...</option>
      </select>
    </div>
    <div class="profile-limit" id="profile-limit-info"></div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('manual')">Manual Entry</div>
    <div class="tab" onclick="switchTab('link')">Payment Link</div>
    <div class="tab" onclick="switchTab('history')">üìã History</div>
    <div class="tab" onclick="switchTab('locations')">üìç Locations</div>
    <div class="tab" onclick="switchTab('report')">üìä Report</div>
    <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>
  </div>

  <!-- MANUAL ENTRY -->
  <div class="panel active" id="panel-manual">
    <div class="field">
      <label>Amount <span class="req">*</span></label>
      <div class="amount-wrap">
        <span>$</span>
        <input type="number" id="m-amount" placeholder="0.00" min="0.01" step="0.01" />
      </div>
      <div class="field-error" id="err-m-amount"></div>
    </div>
    <div class="field">
      <label>Description / Note <span class="req">*</span></label>
      <input type="text" id="m-note" placeholder="Service name, invoice #, etc." />
      <div class="field-error" id="err-m-note"></div>
    </div>
    <div class="field">
      <label>Customer Name (optional)</label>
      <input type="text" id="m-name" placeholder="John Smith" />
    </div>
    <div class="field">
      <label>Customer Email <span class="req">*</span></label>
      <input type="email" id="m-email" placeholder="customer@example.com" />
      <div class="field-error" id="err-m-email"></div>
    </div>
    <div class="field">
      <label>ZIP Code <span class="req">*</span></label>
      <input type="text" id="m-zip" placeholder="10001" maxlength="10" style="max-width:160px" />
      <div class="field-error" id="err-m-zip"></div>
    </div>
    <div class="field">
      <label>Card</label>
      <div id="card-container"></div>
    </div>
    <button class="btn btn-primary" id="btn-charge" onclick="chargeCard()">Charge</button>
    <div class="result" id="result-manual"></div>
  </div>

  <!-- PAYMENT LINK -->
  <div class="panel" id="panel-link">
    <div class="field">
      <label>Location <span class="req">*</span></label>
      <select id="l-location">
        <option value="">Loading locations...</option>
      </select>
      <div class="field-error" id="err-l-location"></div>
    </div>
    <div class="field">
      <label>Amount <span class="req">*</span></label>
      <div class="amount-wrap">
        <span>$</span>
        <input type="number" id="l-amount" placeholder="0.00" min="0.01" step="0.01" />
      </div>
      <div class="field-error" id="err-l-amount"></div>
    </div>
    <div class="field">
      <label>Title <span class="req">*</span></label>
      <input type="text" id="l-title" placeholder="Service name, invoice #..." />
      <div class="field-error" id="err-l-title"></div>
    </div>
    <div class="field">
      <label>Description (optional)</label>
      <input type="text" id="l-desc" placeholder="Additional details..." />
    </div>
    <button class="btn btn-green" id="btn-link" onclick="createLink()">Generate Link</button>
    <div class="result" id="result-link"></div>
  </div>

  <!-- HISTORY -->
  <div class="panel" id="panel-history">
    <div class="tx-list" id="tx-list">
      <div class="empty-state">Loading...</div>
    </div>
  </div>

  <!-- REPORT -->
  <div class="panel" id="panel-report">
    <div class="report-toolbar">
      <div class="period-btns">
        <button class="period-btn active" data-period="today" onclick="setPeriod('today')">Today</button>
        <button class="period-btn" data-period="week" onclick="setPeriod('week')">7 Days</button>
        <button class="period-btn" data-period="month" onclick="setPeriod('month')">This Month</button>
        <button class="period-btn" data-period="year" onclick="setPeriod('year')">This Year</button>
        <button class="period-btn" data-period="custom" onclick="setPeriod('custom')">Custom</button>
      </div>
      <div id="custom-dates" style="display:none;margin-top:10px;display:none">
        <div class="row">
          <div class="field">
            <label>From</label>
            <input type="date" id="report-from" />
          </div>
          <div class="field">
            <label>To</label>
            <input type="date" id="report-to" />
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:0" onclick="loadReport()">Apply</button>
      </div>
    </div>

    <div id="report-summary" style="display:none">
      <div class="report-totals" id="report-totals"></div>
    </div>

    <div id="report-list"><div class="empty-state">Select a period to load report</div></div>
  </div>

  <!-- LOCATIONS -->
  <div class="panel" id="panel-locations">
    <div id="locations-list"><div class="empty-state">Loading...</div></div>

    <hr class="divider" />

    <div class="section-title">‚ûï Create Location</div>
    <div class="field">
      <label>Name <span class="req">*</span></label>
      <input type="text" id="loc-name" placeholder="e.g. Downtown Branch" />
    </div>
    <div class="field">
      <label>Description (optional)</label>
      <input type="text" id="loc-desc" placeholder="Additional info..." />
    </div>
    <div class="field">
      <label>Address (optional)</label>
      <input type="text" id="loc-addr" placeholder="123 Main St" />
    </div>
    <div class="row">
      <div class="field">
        <label>City</label>
        <input type="text" id="loc-city" placeholder="New York" />
      </div>
      <div class="field">
        <label>State</label>
        <input type="text" id="loc-state" placeholder="NY" maxlength="2" />
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>ZIP</label>
        <input type="text" id="loc-zip" placeholder="10001" />
      </div>
      <div class="field">
        <label>Timezone</label>
        <select id="loc-tz">
          <option value="America/New_York">Eastern (ET)</option>
          <option value="America/Chicago">Central (CT)</option>
          <option value="America/Denver">Mountain (MT)</option>
          <option value="America/Los_Angeles">Pacific (PT)</option>
          <option value="America/Anchorage">Alaska</option>
          <option value="Pacific/Honolulu">Hawaii</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" id="btn-create-loc" onclick="createLocation()">Create Location</button>
    <div class="result" id="result-locations"></div>
  </div>

  <!-- SETTINGS -->
  <div class="panel" id="panel-settings">
    <div class="section-title">Your Businesses</div>
    <div class="profile-list" id="profile-list">Loading...</div>

    <hr class="divider" />

    <div id="oauth-connect-block" style="display:none;margin-bottom:20px">
      <div class="section-title">Connect via Square OAuth</div>
      <div class="field">
        <label>Business Name (for the new profile)</label>
        <input type="text" id="oauth-name" placeholder="e.g. My Salon" />
      </div>
      <button class="btn btn-primary" onclick="connectSquare()" style="background:#1a1a1a;display:flex;align-items:center;justify-content:center;gap:10px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm0 4.5a7.5 7.5 0 110 15 7.5 7.5 0 010-15z"/></svg>
        Connect Square Account
      </button>
      <div style="font-size:12px;color:#6b7280;margin-top:8px;text-align:center">–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Square –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>
      <hr class="divider" />
    </div>

    <div class="section-title" id="form-title">‚ûï Add Manually</div>
    <input type="hidden" id="edit-id" />
    <div class="field">
      <label>Business Name <span class="req">*</span></label>
      <input type="text" id="s-name" placeholder="e.g. Acme Salon" />
    </div>
    <div class="field">
      <label>Access Token</label>
      <input type="password" id="s-token" placeholder="EAAl... (leave blank to keep current)" autocomplete="off" />
      <div class="hint" id="s-token-hint"></div>
    </div>
    <div class="row">
      <div class="field">
        <label>Application ID <span class="req">*</span></label>
        <input type="text" id="s-appid" placeholder="sq0idp-..." autocomplete="off" />
      </div>
      <div class="field">
        <label>Location ID <span class="req">*</span></label>
        <input type="text" id="s-locid" placeholder="L..." autocomplete="off" />
      </div>
    </div>
    <div class="field">
      <label>Max Amount per Transaction (optional)</label>
      <div class="amount-wrap">
        <span>$</span>
        <input type="number" id="s-maxamount" placeholder="No limit" min="0.01" step="0.01" />
      </div>
      <div class="hint">Transactions above this amount will be blocked</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-primary" onclick="saveProfile()" style="flex:1">Save Business</button>
      <button class="btn btn-sm" id="btn-cancel-edit" onclick="cancelEdit()" style="display:none;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;padding:13px 16px">Cancel</button>
    </div>
    <div class="result" id="result-settings"></div>
  </div>
</div>

<script>
let card;
let appId, locId;
let profilesData = { activeId: null, profiles: [] };

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAuth() {
  const res = await fetch('/api/auth-status').then(r => r.json());
  if (res.authenticated) {
    showApp();
  } else {
    showLogin();
  }
}

function showLogin() {
  document.getElementById('login-screen').classList.add('visible');
  document.getElementById('app').style.display = 'none';
  setTimeout(() => document.getElementById('login-password').focus(), 100);
}

function showApp() {
  document.getElementById('login-screen').classList.remove('visible');
  document.getElementById('app').style.display = 'block';
  init();
}

async function doLogin() {
  const password = document.getElementById('login-password').value;
  const btn = document.getElementById('btn-login');
  const err = document.getElementById('login-error');
  const input = document.getElementById('login-password');
  err.style.display = 'none';
  input.classList.remove('error');
  btn.disabled = true;
  btn.textContent = 'Signing in...';

  const res = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password }),
  }).then(r => r.json());

  if (res.success) {
    showApp();
  } else {
    err.style.display = 'block';
    input.classList.add('error');
    input.value = '';
    input.focus();
  }
  btn.disabled = false;
  btn.textContent = 'Sign In';
}

async function doLogout() {
  await fetch('/api/logout', { method: 'POST' });
  showLogin();
}

// ‚îÄ‚îÄ OAuth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectSquare() {
  const name = document.getElementById('oauth-name').value.trim() || 'New Business';
  window.location.href = `/auth/square?name=${encodeURIComponent(name)}`;
}

function checkOAuthResult() {
  const params = new URLSearchParams(window.location.search);
  const oauth = params.get('oauth');
  if (!oauth) return;
  // Clean URL
  window.history.replaceState({}, '', '/');
  if (oauth === 'success') {
    const name = params.get('name') || 'New Business';
    setTimeout(() => {
      showResult(document.getElementById('result-settings'), 'success', `‚úÖ "${name}" –ø–æ–¥–∫–ª—é—á—ë–Ω —á–µ—Ä–µ–∑ Square OAuth!`);
      switchTab('settings');
    }, 500);
  } else if (oauth === 'error') {
    setTimeout(() => {
      showResult(document.getElementById('result-settings'), 'error', '‚ùå OAuth error: ' + (params.get('msg') || 'Unknown'));
      switchTab('settings');
    }, 500);
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  // Check OAuth result in URL
  checkOAuthResult();
  // Check if OAuth is configured
  const oauthCfg = await fetch('/api/oauth-config').then(r => r.json());
  if (oauthCfg.enabled) {
    document.getElementById('oauth-connect-block').style.display = 'block';
  }
  await loadProfiles();
  await initSquare();
}

async function initSquare() {
  const cfg = await fetch('/api/config').then(r => r.json());
  appId = cfg.applicationId;
  locId = cfg.locationId;
  if (card) { try { await card.destroy(); } catch {} }
  document.getElementById('card-container').innerHTML = '';
  const payments = Square.payments(appId, locId);
  card = await payments.card();
  await card.attach('#card-container');
}

// ‚îÄ‚îÄ Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProfiles() {
  profilesData = await fetch('/api/profiles').then(r => r.json());
  renderProfileSwitcher();
  renderProfileList();
  updateLimitInfo();
}

function updateLimitInfo() {
  const active = profilesData.profiles.find(p => p.id === profilesData.activeId);
  const el = document.getElementById('profile-limit-info');
  if (active && active.maxAmount) {
    el.textContent = `Max per transaction: $${active.maxAmount.toFixed(2)}`;
  } else {
    el.textContent = '';
  }
}

function renderProfileSwitcher() {
  const sel = document.getElementById('profile-switcher');
  sel.innerHTML = profilesData.profiles.map(p =>
    `<option value="${p.id}" ${p.id === profilesData.activeId ? 'selected' : ''}>${p.name}</option>`
  ).join('');
}

function renderProfileList() {
  const el = document.getElementById('profile-list');
  if (!profilesData.profiles.length) {
    el.innerHTML = '<div style="color:#6b7280;font-size:13px">No profiles yet.</div>';
    return;
  }
  el.innerHTML = profilesData.profiles.map(p => `
    <div class="profile-card ${p.active ? 'is-active' : ''}" id="card-${p.id}">
      <div class="profile-card-header">
        <div style="flex:1">
          <div class="profile-card-name">${p.name}</div>
          <div class="profile-card-sub">
            ${p.maxAmount ? `Limit: $${p.maxAmount.toFixed(2)} ¬∑ ` : ''}
            ${p.transactionCount} transaction${p.transactionCount !== 1 ? 's' : ''}
          </div>
        </div>
        ${p.active ? '<span class="badge-active">Active</span>' : ''}
      </div>
      <div class="merchant-info loading" id="merchant-${p.id}">Loading merchant info...</div>
      <div class="profile-card-actions">
        ${!p.active ? `<button class="btn btn-primary btn-sm" onclick="switchProfile('${p.id}')">Activate</button>` : ''}
        <button class="btn btn-sm" onclick="editProfile('${p.id}')" style="background:#f3f4f6;color:#374151;border:1px solid #d1d5db">Edit</button>
        ${!p.active ? `<button class="btn btn-danger btn-sm" onclick="deleteProfile('${p.id}')">Delete</button>` : ''}
      </div>
    </div>
  `).join('');

  // Load merchant info for all profiles
  profilesData.profiles.forEach(p => loadMerchantInfo(p.id));
}

async function loadMerchantInfo(profileId) {
  const el = document.getElementById(`merchant-${profileId}`);
  if (!el) return;
  try {
    const m = await fetch(`/api/profiles/${profileId}/merchant`).then(r => r.json());
    if (m.error) {
      el.className = 'merchant-info error-state';
      el.innerHTML = `‚ö†Ô∏è ${m.error}`;
      return;
    }
    const isActive = m.status === 'ACTIVE';
    const statusDot = `<span class="status-dot ${isActive ? 'active' : 'inactive'}"></span>`;
    el.className = 'merchant-info';
    el.innerHTML = `
      <div class="merchant-grid">
        <div class="merchant-field">
          <label>Business Name</label>
          <span>${m.business_name || m.company_name || '‚Äî'}</span>
        </div>
        <div class="merchant-field">
          <label>Status</label>
          <span>${statusDot}${m.status || '‚Äî'}</span>
        </div>
        <div class="merchant-field">
          <label>Country</label>
          <span>${m.country || '‚Äî'}</span>
        </div>
        <div class="merchant-field">
          <label>Currency</label>
          <span>${m.currency || '‚Äî'}</span>
        </div>
        <div class="merchant-field">
          <label>Language</label>
          <span>${m.language_code || '‚Äî'}</span>
        </div>
        <div class="merchant-field">
          <label>Merchant ID</label>
          <span style="font-size:10px">${m.id || '‚Äî'}</span>
        </div>
      </div>`;
  } catch (e) {
    el.className = 'merchant-info error-state';
    el.innerHTML = `‚ö†Ô∏è Failed to load`;
  }
}

async function switchProfile(id) {
  const res = await fetch(`/api/profiles/${id}/activate`, { method: 'POST' }).then(r => r.json());
  if (res.success) {
    profilesData.activeId = id;
    profilesData.profiles.forEach(p => p.active = p.id === id);
    renderProfileSwitcher();
    renderProfileList();
    updateLimitInfo();
    document.getElementById('l-location').dataset.loaded = ''; // reset location cache
    await initSquare();
  }
}

function editProfile(id) {
  const p = profilesData.profiles.find(x => x.id === id);
  if (!p) return;
  document.getElementById('edit-id').value = p.id;
  document.getElementById('s-name').value = p.name;
  document.getElementById('s-appid').value = p.applicationId;
  document.getElementById('s-locid').value = p.locationId;
  document.getElementById('s-maxamount').value = p.maxAmount || '';
  document.getElementById('s-token').value = '';
  document.getElementById('s-token-hint').textContent = 'Current: ' + p.accessTokenMasked;
  document.getElementById('form-title').textContent = '‚úèÔ∏è Edit Business';
  document.getElementById('btn-cancel-edit').style.display = 'inline-block';
  document.getElementById('panel-settings').scrollTo({ top: 9999, behavior: 'smooth' });
}

function cancelEdit() {
  ['edit-id','s-name','s-appid','s-locid','s-token','s-maxamount'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('s-token-hint').textContent = '';
  document.getElementById('form-title').textContent = '‚ûï Add Business';
  document.getElementById('btn-cancel-edit').style.display = 'none';
}

async function saveProfile() {
  const id = document.getElementById('edit-id').value;
  const name = document.getElementById('s-name').value.trim();
  const token = document.getElementById('s-token').value.trim();
  const appId = document.getElementById('s-appid').value.trim();
  const locId = document.getElementById('s-locid').value.trim();
  const maxAmount = document.getElementById('s-maxamount').value.trim();
  const result = document.getElementById('result-settings');

  if (!name || !appId || !locId) {
    showResult(result, 'error', 'Name, Application ID and Location ID are required.');
    return;
  }
  if (!id && !token) {
    showResult(result, 'error', 'Access Token is required for a new business.');
    return;
  }

  const body = { name, applicationId: appId, locationId: locId };
  if (id) body.id = id;
  if (token) body.accessToken = token;
  if (maxAmount) body.maxAmount = parseFloat(maxAmount);

  const res = await fetch('/api/profiles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  }).then(r => r.json());

  if (res.success) {
    showResult(result, 'success', '‚úÖ Saved!');
    cancelEdit();
    await loadProfiles();
  } else {
    showResult(result, 'error', '‚ùå ' + (res.error || 'Save failed'));
  }
}

async function deleteProfile(id) {
  if (!confirm('Delete this business profile and all its history?')) return;
  const res = await fetch(`/api/profiles/${id}`, { method: 'DELETE' }).then(r => r.json());
  if (res.success) await loadProfiles();
  else alert(res.error || 'Delete failed');
}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHistory() {
  const activeId = profilesData.activeId;
  if (!activeId) return;
  const data = await fetch(`/api/profiles/${activeId}/transactions`).then(r => r.json());
  const el = document.getElementById('tx-list');
  const txs = data.transactions || [];
  if (!txs.length) {
    el.innerHTML = '<div class="empty-state">üì≠ No transactions yet for this business</div>';
    return;
  }
  el.innerHTML = txs.map(tx => {
    const isFail = tx.status === 'FAILED';
    const isLink = tx.type === 'link';
    const badgeClass = isFail ? 'badge-fail' : isLink ? 'badge-link' : 'badge-ok';
    const badgeText = isFail ? '‚úó Failed' : isLink ? 'üîó Link' : '‚úì Charged';
    const itemClass = isFail ? 'failed' : isLink ? 'link-created' : '';
    const date = new Date(tx.createdAt).toLocaleString();
    const receiptHtml = tx.receiptUrl ? `<a class="tx-receipt" href="${tx.receiptUrl}" target="_blank">Receipt ‚Üó</a>` : '';
    const linkHtml = tx.url ? `<a class="tx-receipt" href="${tx.url}" target="_blank">Link ‚Üó</a>` : '';
    const errorHtml = tx.error ? `<div class="tx-note" style="color:#ef4444">${tx.error}</div>` : '';
    return `
      <div class="tx-item ${itemClass}">
        <div class="tx-row">
          <div class="tx-amount">$${tx.amount.toFixed(2)} <span style="font-size:12px;font-weight:400;color:#6b7280">${tx.currency}</span></div>
          <span class="tx-badge ${badgeClass}">${badgeText}</span>
        </div>
        ${tx.note ? `<div class="tx-note">${tx.note}</div>` : ''}
        ${tx.buyerEmail ? `<div class="tx-note">${tx.buyerEmail}</div>` : ''}
        ${errorHtml}
        <div class="tx-row" style="margin-top:4px">
          <div class="tx-date">${date}</div>
          ${receiptHtml}${linkHtml}
        </div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active',
      (i === 0 && tab === 'manual') || (i === 1 && tab === 'link') ||
      (i === 2 && tab === 'history') || (i === 3 && tab === 'locations') ||
      (i === 4 && tab === 'report')  || (i === 5 && tab === 'settings')
    );
  });
  ['manual','link','history','locations','report','settings'].forEach(id => {
    document.getElementById('panel-' + id).classList.toggle('active', tab === id);
  });
  if (tab === 'link')      loadLinkLocations();
  if (tab === 'history')   loadHistory();
  if (tab === 'locations') loadLocations();
  if (tab === 'report')    loadReport();
  if (tab === 'settings')  loadProfiles();
}

// ‚îÄ‚îÄ Report ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentPeriod = 'month';

function setPeriod(period) {
  currentPeriod = period;
  document.querySelectorAll('.period-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.period === period)
  );
  const customDates = document.getElementById('custom-dates');
  customDates.style.display = period === 'custom' ? 'block' : 'none';
  if (period !== 'custom') loadReport();
}

async function loadReport() {
  const el = document.getElementById('report-list');
  const summaryEl = document.getElementById('report-summary');
  el.innerHTML = '<div class="empty-state"><span class="spinner" style="border-color:rgba(0,106,255,0.3);border-top-color:#006AFF"></span> Loading from Square...</div>';
  summaryEl.style.display = 'none';

  const params = new URLSearchParams({ period: currentPeriod });
  if (currentPeriod === 'custom') {
    const from = document.getElementById('report-from').value;
    const to   = document.getElementById('report-to').value;
    if (!from || !to) { el.innerHTML = '<div class="empty-state">Select date range</div>'; return; }
    params.set('begin', from);
    params.set('end', to + 'T23:59:59');
  }

  try {
    const data = await fetch(`/api/profiles/${profilesData.activeId}/report?${params}`).then(r => r.json());
    if (data.error) {
      el.innerHTML = `<div class="empty-state" style="color:#ef4444">‚ö†Ô∏è ${data.error}<br><small>Your Access Token may need PAYMENTS_READ permission</small></div>`;
      return;
    }

    const activeLocs = data.locations.filter(l => l.status === 'ACTIVE');
    const inactiveLocs = data.locations.filter(l => l.status !== 'ACTIVE');

    // Grand totals
    const grandTotal   = activeLocs.reduce((s, l) => s + parseFloat(l.totalAmount  || 0), 0);
    const grandNet     = activeLocs.reduce((s, l) => s + parseFloat(l.net          || 0), 0);
    const grandFees    = activeLocs.reduce((s, l) => s + parseFloat(l.totalFees    || 0), 0);
    const grandRefunds = activeLocs.reduce((s, l) => s + parseFloat(l.totalRefunds || 0), 0);
    const grandCount   = activeLocs.reduce((s, l) => s + (l.countOk || 0), 0);

    const periodLabel = { today: 'Today', week: 'Last 7 Days', month: 'This Month', year: 'This Year', custom: 'Custom Range' }[currentPeriod];

    document.getElementById('report-totals').innerHTML = `
      <div class="report-total-card highlight" style="grid-column:span 2">
        <div class="report-total-label">Total Revenue ¬∑ ${periodLabel}</div>
        <div class="report-total-value">$${grandTotal.toFixed(2)}</div>
      </div>
      <div class="report-total-card">
        <div class="report-total-label">Net (after fees)</div>
        <div class="report-total-value">$${grandNet.toFixed(2)}</div>
      </div>
      <div class="report-total-card">
        <div class="report-total-label">Processing Fees</div>
        <div class="report-total-value" style="color:#ef4444">-$${grandFees.toFixed(2)}</div>
      </div>
      <div class="report-total-card">
        <div class="report-total-label">Refunds</div>
        <div class="report-total-value" style="color:#f59e0b">-$${grandRefunds.toFixed(2)}</div>
      </div>
      <div class="report-total-card">
        <div class="report-total-label">Completed Payments</div>
        <div class="report-total-value">${grandCount}</div>
      </div>`;
    summaryEl.style.display = 'block';

    el.innerHTML = activeLocs.map(l => {
      const isCurrent = l.locationId === (profilesData.profiles.find(p => p.id === profilesData.activeId)?.locationId);
      return `
        <div class="report-loc-card ${isCurrent ? 'is-current' : ''}">
          <div class="report-loc-header">
            <div>
              <div class="report-loc-name">${l.locationName}${isCurrent ? ' <span style="font-size:11px;color:#006AFF">(current)</span>' : ''}</div>
              <div style="font-size:11px;color:#9ca3af">${l.countOk} payments ¬∑ ${l.currency}</div>
            </div>
            <div class="report-loc-total">$${l.totalAmount}</div>
          </div>
          <div class="report-loc-body">
            <div class="report-stat">
              <div class="report-stat-val" style="color:#10b981">$${l.net}</div>
              <div class="report-stat-lbl">Net</div>
            </div>
            <div class="report-stat">
              <div class="report-stat-val" style="color:#ef4444">-$${l.totalFees}</div>
              <div class="report-stat-lbl">Fees</div>
            </div>
            <div class="report-stat">
              <div class="report-stat-val" style="color:#f59e0b">-$${l.totalRefunds}</div>
              <div class="report-stat-lbl">Refunds</div>
            </div>
            <div class="report-stat">
              <div class="report-stat-val" style="color:#ef4444">${l.countFailed}</div>
              <div class="report-stat-lbl">Failed</div>
            </div>
          </div>
        </div>`;
    }).join('') +
    (inactiveLocs.length ? `<div class="report-inactive" style="margin-top:8px">+ ${inactiveLocs.length} inactive location(s) skipped</div>` : '');

  } catch (e) {
    el.innerHTML = `<div class="empty-state" style="color:#ef4444">‚ö†Ô∏è ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ Link Locations selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLinkLocations() {
  const sel = document.getElementById('l-location');
  if (sel.dataset.loaded === profilesData.activeId) return; // already loaded for this profile
  sel.innerHTML = '<option value="">Loading...</option>';
  try {
    const data = await fetch(`/api/profiles/${profilesData.activeId}/locations`).then(r => r.json());
    const locs = (data.locations || []).filter(l => l.status === 'ACTIVE');
    if (!locs.length) {
      sel.innerHTML = '<option value="">No active locations found</option>';
      return;
    }
    const active = profilesData.profiles.find(p => p.id === profilesData.activeId);
    sel.innerHTML = locs.map(l =>
      `<option value="${l.id}" ${l.id === active?.locationId ? 'selected' : ''}>${l.name}${l.address ? ' ‚Äî ' + l.address : ''}</option>`
    ).join('');
    sel.dataset.loaded = profilesData.activeId;
  } catch {
    sel.innerHTML = '<option value="">Failed to load locations</option>';
  }
}

// ‚îÄ‚îÄ Locations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLocations() {
  const el = document.getElementById('locations-list');
  el.innerHTML = '<div class="empty-state">Loading...</div>';
  const activeId = profilesData.activeId;
  if (!activeId) return;

  try {
    const data = await fetch(`/api/profiles/${activeId}/locations`).then(r => r.json());
    if (data.error) {
      el.innerHTML = `<div class="empty-state" style="color:#ef4444">‚ö†Ô∏è ${data.error}</div>`;
      return;
    }
    const locs = data.locations || [];
    if (!locs.length) {
      el.innerHTML = '<div class="empty-state">No locations found</div>';
      return;
    }
    el.innerHTML = locs.map(l => {
      const isActive = l.isActive;
      const statusClass = l.status === 'ACTIVE' ? 'loc-status-active' : 'loc-status-inactive';
      const total = l.totals.charged + l.totals.links;
      return `
        <div class="loc-card ${isActive ? 'loc-active' : ''}">
          <div class="loc-header">
            <div style="flex:1">
              <div class="loc-name">${l.name}${isActive ? ' <span style="font-size:11px;color:#006AFF">(current)</span>' : ''}</div>
              ${l.address ? `<div class="loc-addr">üìç ${l.address}</div>` : ''}
              <div class="loc-addr">${l.timezone || ''} ¬∑ ${l.currency || ''} ¬∑ ${l.type || ''}</div>
              <div class="loc-addr" style="font-size:10px;color:#9ca3af">${l.id}</div>
            </div>
            <span class="loc-status-badge ${statusClass}">${l.status}</span>
          </div>
          <div class="loc-stats">
            <div class="loc-stat">
              <div class="loc-stat-value">$${total.toFixed(2)}</div>
              <div class="loc-stat-label">Total via Terminal</div>
            </div>
            <div class="loc-stat">
              <div class="loc-stat-value">$${l.totals.charged.toFixed(2)}</div>
              <div class="loc-stat-label">Charged</div>
            </div>
            <div class="loc-stat">
              <div class="loc-stat-value">${l.totals.count}</div>
              <div class="loc-stat-label">Transactions</div>
            </div>
          </div>
        </div>`;
    }).join('');
  } catch (e) {
    el.innerHTML = `<div class="empty-state" style="color:#ef4444">‚ö†Ô∏è ${e.message}</div>`;
  }
}

async function createLocation() {
  const name    = document.getElementById('loc-name').value.trim();
  const desc    = document.getElementById('loc-desc').value.trim();
  const addr    = document.getElementById('loc-addr').value.trim();
  const city    = document.getElementById('loc-city').value.trim();
  const state   = document.getElementById('loc-state').value.trim();
  const zip     = document.getElementById('loc-zip').value.trim();
  const tz      = document.getElementById('loc-tz').value;
  const btn     = document.getElementById('btn-create-loc');
  const result  = document.getElementById('result-locations');

  if (!name) { showResult(result, 'error', 'Location name is required.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Creating...';
  result.style.display = 'none';

  const res = await fetch(`/api/profiles/${profilesData.activeId}/locations`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, description: desc, address_line_1: addr, city, state, postal_code: zip, timezone: tz }),
  }).then(r => r.json());

  if (res.success) {
    showResult(result, 'success', `‚úÖ Location "${res.location.name}" created! ID: ${res.location.id}`);
    ['loc-name','loc-desc','loc-addr','loc-city','loc-state','loc-zip'].forEach(id => document.getElementById(id).value = '');
    loadLocations();
  } else {
    showResult(result, 'error', '‚ùå ' + (res.error || 'Failed to create location'));
  }

  btn.disabled = false;
  btn.innerHTML = 'Create Location';
}

// ‚îÄ‚îÄ Validation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clearErrors() {
  document.querySelectorAll('.field-error').forEach(el => el.textContent = '');
  document.querySelectorAll('input.error, textarea.error').forEach(el => el.classList.remove('error'));
}

function fieldError(id, msg) {
  const input = document.getElementById(id);
  if (input) input.classList.add('error');
  const err = document.getElementById('err-' + id);
  if (err) err.textContent = msg;
}

// ‚îÄ‚îÄ Charge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function chargeCard() {
  clearErrors();
  const amount = document.getElementById('m-amount').value;
  const note   = document.getElementById('m-note').value.trim();
  const name   = document.getElementById('m-name').value.trim();
  const email  = document.getElementById('m-email').value.trim();
  const zip    = document.getElementById('m-zip').value.trim();
  const btn    = document.getElementById('btn-charge');
  const result = document.getElementById('result-manual');

  let valid = true;
  if (!amount || parseFloat(amount) <= 0) { fieldError('m-amount', 'Required'); valid = false; }
  if (!note) { fieldError('m-note', 'Please describe what this payment is for'); valid = false; }
  if (!email) { fieldError('m-email', 'Email is required to send a receipt and reduce chargebacks'); valid = false; }
  if (!zip)  { fieldError('m-zip', 'ZIP code helps verify the card and reduce fraud'); valid = false; }
  if (!valid) return;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Processing...';
  result.style.display = 'none';

  try {
    const tokenResult = await card.tokenize();
    if (tokenResult.status !== 'OK') throw new Error(tokenResult.errors?.map(e => e.message).join(', ') || 'Tokenization failed');

    const payments = Square.payments(appId, locId);
    const verifyResult = await payments.verifyBuyer(tokenResult.token, {
      intent: 'CHARGE', customerInitiated: true, sellerKeyedIn: true,
      amount: parseFloat(amount).toFixed(2), currencyCode: 'USD',
      billingContact: { postalCode: zip },
    });

    const res = await fetch('/api/charge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sourceId: tokenResult.token,
        verificationToken: verifyResult?.token,
        amount, currency: 'USD',
        note: [name, note].filter(Boolean).join(' ‚Äî '),
        buyerEmail: email,
      }),
    }).then(r => r.json());

    if (res.success) {
      const receipt = res.receiptUrl ? ` <a href="${res.receiptUrl}" target="_blank" style="color:#065f46">View Receipt ‚Üó</a>` : '';
      showResult(result, 'success', `‚úÖ Payment successful!<br>ID: ${res.paymentId}${receipt}`);
      // Clear form
      ['m-amount','m-note','m-name','m-email','m-zip'].forEach(id => document.getElementById(id).value = '');
    } else {
      showResult(result, 'error', '‚ùå ' + (res.errors?.map(e => e.detail).join('<br>') || 'Payment failed'));
    }
  } catch (e) {
    showResult(result, 'error', '‚ùå ' + e.message);
  }

  btn.disabled = false;
  btn.innerHTML = 'Charge';
}

// ‚îÄ‚îÄ Payment Link ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function createLink() {
  clearErrors();
  const locationId = document.getElementById('l-location').value;
  const amount = document.getElementById('l-amount').value;
  const title  = document.getElementById('l-title').value.trim();
  const desc   = document.getElementById('l-desc').value.trim();
  const btn    = document.getElementById('btn-link');
  const result = document.getElementById('result-link');

  let valid = true;
  if (!locationId) { fieldError('l-location', 'Please select a location'); valid = false; }
  if (!amount || parseFloat(amount) <= 0) { fieldError('l-amount', 'Required'); valid = false; }
  if (!title) { fieldError('l-title', 'Title is required ‚Äî it appears on the payment page'); valid = false; }
  if (!valid) return;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Generating...';
  result.style.display = 'none';

  const res = await fetch('/api/payment-link', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ amount, currency: 'USD', title, description: desc, locationId }),
  }).then(r => r.json());

  if (res.success) {
    result.className = 'result success';
    result.style.display = 'block';
    result.innerHTML = `‚úÖ Link created!
      <div class="link-box">
        <input type="text" id="link-url" value="${res.url}" readonly />
        <button class="btn-copy" onclick="copyLink()">Copy</button>
      </div>`;
    document.getElementById('l-amount').value = '';
    document.getElementById('l-title').value = '';
    document.getElementById('l-desc').value = '';
  } else {
    showResult(result, 'error', '‚ùå ' + (res.errors?.map(e => e.detail).join('<br>') || 'Failed'));
  }

  btn.disabled = false;
  btn.innerHTML = 'Generate Link';
}

function copyLink() {
  navigator.clipboard.writeText(document.getElementById('link-url').value).then(() => {
    const btn = document.querySelector('.btn-copy');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

function showResult(el, type, msg) {
  el.className = 'result ' + type;
  el.innerHTML = msg;
  el.style.display = 'block';
}

checkAuth();
</script>
</body>
</html>

