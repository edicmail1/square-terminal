<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Terminal</title>
  <script src="https://web.squarecdn.com/v1/square.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f4f5f7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      width: 100%;
      max-width: 480px;
      overflow: hidden;
    }
    .header {
      background: #006AFF;
      color: white;
      padding: 20px 28px;
    }
    .header h1 { font-size: 20px; font-weight: 600; }
    .header p { font-size: 12px; opacity: 0.8; margin-top: 3px; }
    .profile-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 8px 12px;
    }
    .profile-bar label {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      white-space: nowrap;
    }
    .profile-select {
      flex: 1;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      padding: 5px 8px;
      cursor: pointer;
      outline: none;
    }
    .profile-select option { background: #006AFF; color: white; }
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab {
      flex: 1;
      padding: 13px 8px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active { color: #006AFF; border-bottom-color: #006AFF; }
    .panel { display: none; padding: 22px 28px; }
    .panel.active { display: block; }
    .field { margin-bottom: 15px; }
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 5px;
    }
    input[type="text"], input[type="number"], input[type="email"],
    input[type="password"], select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border 0.2s;
    }
    input:focus, select:focus { border-color: #006AFF; }
    .amount-wrap { position: relative; }
    .amount-wrap span {
      position: absolute; left: 12px; top: 50%;
      transform: translateY(-50%); color: #6b7280; font-size: 14px;
    }
    .amount-wrap input { padding-left: 24px; }
    #card-container {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px 12px;
      min-height: 44px;
    }
    .btn {
      width: 100%; padding: 13px; border: none; border-radius: 8px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      transition: background 0.2s; margin-top: 8px;
    }
    .btn-primary { background: #006AFF; color: white; }
    .btn-primary:hover { background: #0057d4; }
    .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }
    .btn-link { background: #10b981; color: white; }
    .btn-link:hover { background: #059669; }
    .btn-link:disabled { background: #6ee7b7; cursor: not-allowed; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm {
      width: auto; padding: 6px 14px; font-size: 13px; margin-top: 0;
    }
    .result {
      margin-top: 14px; padding: 13px; border-radius: 8px;
      font-size: 14px; display: none;
    }
    .result.success { background: #ecfdf5; color: #065f46; border: 1px solid #6ee7b7; }
    .result.error { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }
    .link-box { display: flex; gap: 8px; margin-top: 10px; }
    .link-box input { flex: 1; background: #f9fafb; font-size: 13px; }
    .btn-copy {
      padding: 10px 14px; background: #006AFF; color: white;
      border: none; border-radius: 8px; cursor: pointer;
      font-size: 13px; font-weight: 600; white-space: nowrap;
    }
    .btn-copy:hover { background: #0057d4; }
    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
      border-radius: 50%; animation: spin 0.7s linear infinite;
      vertical-align: middle; margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Settings - profile list */
    .profile-list { margin-bottom: 20px; }
    .profile-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border: 1px solid #e5e7eb;
      border-radius: 8px; margin-bottom: 8px;
      background: #f9fafb;
    }
    .profile-item.is-active { border-color: #006AFF; background: #eff6ff; }
    .profile-item-name { flex: 1; font-size: 14px; font-weight: 600; color: #111827; }
    .profile-item-sub { font-size: 11px; color: #6b7280; margin-top: 2px; }
    .badge-active {
      font-size: 11px; background: #006AFF; color: white;
      padding: 2px 8px; border-radius: 20px; white-space: nowrap;
    }
    .divider { border: none; border-top: 1px solid #e5e7eb; margin: 20px 0; }
    .section-title { font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; }
    .hint { font-size: 11px; color: #9ca3af; margin-top: 4px; }
    .row { display: flex; gap: 10px; }
    .row .field { flex: 1; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ’³ Payment Terminal</h1>
    <p>Manual entry or send payment link</p>
    <div class="profile-bar">
      <label>Business:</label>
      <select class="profile-select" id="profile-switcher" onchange="switchProfile(this.value)">
        <option>Loading...</option>
      </select>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('manual')">Manual Entry</div>
    <div class="tab" onclick="switchTab('link')">Payment Link</div>
    <div class="tab" onclick="switchTab('settings')">âš™ï¸ Settings</div>
  </div>

  <!-- MANUAL ENTRY -->
  <div class="panel active" id="panel-manual">
    <div class="field">
      <label>Amount</label>
      <div class="amount-wrap">
        <span>$</span>
        <input type="number" id="m-amount" placeholder="0.00" min="0.01" step="0.01" />
      </div>
    </div>
    <div class="field">
      <label>Customer Name (optional)</label>
      <input type="text" id="m-name" placeholder="John Smith" />
    </div>
    <div class="field">
      <label>Note (optional)</label>
      <input type="text" id="m-note" placeholder="Invoice #123, service description..." />
    </div>
    <div class="field">
      <label>Customer Email (for receipt)</label>
      <input type="email" id="m-email" placeholder="customer@example.com" />
    </div>
    <div class="field">
      <label>ZIP Code (recommended)</label>
      <input type="text" id="m-zip" placeholder="10001" maxlength="10" style="max-width:160px" />
    </div>
    <div class="field">
      <label>Card</label>
      <div id="card-container"></div>
    </div>
    <button class="btn btn-primary" id="btn-charge" onclick="chargeCard()">Charge</button>
    <div class="result" id="result-manual"></div>
  </div>

  <!-- PAYMENT LINK -->
  <div class="panel" id="panel-link">
    <div class="field">
      <label>Amount</label>
      <div class="amount-wrap">
        <span>$</span>
        <input type="number" id="l-amount" placeholder="0.00" min="0.01" step="0.01" />
      </div>
    </div>
    <div class="field">
      <label>Title (optional)</label>
      <input type="text" id="l-title" placeholder="Payment for services" />
    </div>
    <div class="field">
      <label>Description (optional)</label>
      <input type="text" id="l-desc" placeholder="Additional details..." />
    </div>
    <button class="btn btn-link" id="btn-link" onclick="createLink()">Generate Link</button>
    <div class="result" id="result-link"></div>
  </div>

  <!-- SETTINGS -->
  <div class="panel" id="panel-settings">

    <!-- Profile list -->
    <div class="section-title">Your Businesses</div>
    <div class="profile-list" id="profile-list">Loading...</div>

    <hr class="divider" />

    <!-- Add / Edit form -->
    <div class="section-title" id="form-title">â• Add Business</div>
    <input type="hidden" id="edit-id" />
    <div class="field">
      <label>Business Name</label>
      <input type="text" id="s-name" placeholder="e.g. Acme Salon" />
    </div>
    <div class="field">
      <label>Access Token</label>
      <input type="password" id="s-token" placeholder="EAAl..." autocomplete="off" />
      <div class="hint" id="s-token-hint"></div>
    </div>
    <div class="row">
      <div class="field">
        <label>Application ID</label>
        <input type="text" id="s-appid" placeholder="sq0idp-..." autocomplete="off" />
      </div>
      <div class="field">
        <label>Location ID</label>
        <input type="text" id="s-locid" placeholder="L..." autocomplete="off" />
      </div>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-primary" id="btn-save-profile" onclick="saveProfile()" style="flex:1">Save Business</button>
      <button class="btn btn-sm" id="btn-cancel-edit" onclick="cancelEdit()" style="display:none;background:#f3f4f6;color:#374151;border:1px solid #d1d5db">Cancel</button>
    </div>
    <div class="result" id="result-settings"></div>
  </div>
</div>

<script>
let card;
let appId, locId;
let profilesData = { activeId: null, profiles: [] };

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await loadProfiles();
  await initSquare();
}

async function initSquare() {
  const cfg = await fetch('/api/config').then(r => r.json());
  appId = cfg.applicationId;
  locId = cfg.locationId;
  if (card) { try { await card.destroy(); } catch {} }
  document.getElementById('card-container').innerHTML = '';
  const payments = Square.payments(appId, locId);
  card = await payments.card();
  await card.attach('#card-container');
}

// â”€â”€ Profiles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfiles() {
  profilesData = await fetch('/api/profiles').then(r => r.json());
  renderProfileSwitcher();
  renderProfileList();
}

function renderProfileSwitcher() {
  const sel = document.getElementById('profile-switcher');
  sel.innerHTML = profilesData.profiles.map(p =>
    `<option value="${p.id}" ${p.id === profilesData.activeId ? 'selected' : ''}>${p.name}</option>`
  ).join('');
}

function renderProfileList() {
  const el = document.getElementById('profile-list');
  if (!profilesData.profiles.length) { el.innerHTML = '<div style="color:#6b7280;font-size:13px">No profiles yet.</div>'; return; }
  el.innerHTML = profilesData.profiles.map(p => `
    <div class="profile-item ${p.active ? 'is-active' : ''}">
      <div style="flex:1">
        <div class="profile-item-name">${p.name}</div>
        <div class="profile-item-sub">${p.applicationId} Â· ${p.locationId}</div>
      </div>
      ${p.active ? '<span class="badge-active">Active</span>' : ''}
      <button class="btn btn-sm btn-primary" onclick="editProfile('${p.id}')" style="padding:5px 10px;font-size:12px">Edit</button>
      ${!p.active ? `<button class="btn btn-sm btn-danger" onclick="deleteProfile('${p.id}')" style="padding:5px 10px;font-size:12px">âœ•</button>` : ''}
    </div>
  `).join('');
}

async function switchProfile(id) {
  const res = await fetch(`/api/profiles/${id}/activate`, { method: 'POST' }).then(r => r.json());
  if (res.success) {
    profilesData.activeId = id;
    profilesData.profiles.forEach(p => p.active = p.id === id);
    renderProfileList();
    await initSquare();
  }
}

function editProfile(id) {
  const p = profilesData.profiles.find(x => x.id === id);
  if (!p) return;
  document.getElementById('edit-id').value = p.id;
  document.getElementById('s-name').value = p.name;
  document.getElementById('s-appid').value = p.applicationId;
  document.getElementById('s-locid').value = p.locationId;
  document.getElementById('s-token').value = '';
  document.getElementById('s-token-hint').textContent = 'Token: ' + p.accessTokenMasked + ' (leave blank to keep)';
  document.getElementById('form-title').textContent = 'âœï¸ Edit Business';
  document.getElementById('btn-cancel-edit').style.display = 'inline-block';
  document.getElementById('panel-settings').scrollTop = 9999;
}

function cancelEdit() {
  document.getElementById('edit-id').value = '';
  document.getElementById('s-name').value = '';
  document.getElementById('s-appid').value = '';
  document.getElementById('s-locid').value = '';
  document.getElementById('s-token').value = '';
  document.getElementById('s-token-hint').textContent = '';
  document.getElementById('form-title').textContent = 'â• Add Business';
  document.getElementById('btn-cancel-edit').style.display = 'none';
}

async function saveProfile() {
  const id = document.getElementById('edit-id').value;
  const name = document.getElementById('s-name').value.trim();
  const token = document.getElementById('s-token').value.trim();
  const appId = document.getElementById('s-appid').value.trim();
  const locId = document.getElementById('s-locid').value.trim();
  const result = document.getElementById('result-settings');

  if (!name || !appId || !locId) {
    showResult(result, 'error', 'Name, Application ID and Location ID are required.');
    return;
  }
  if (!id && !token) {
    showResult(result, 'error', 'Access Token is required for a new business.');
    return;
  }

  const body = { name, applicationId: appId, locationId: locId };
  if (id) body.id = id;
  if (token) body.accessToken = token;

  const res = await fetch('/api/profiles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  }).then(r => r.json());

  if (res.success) {
    showResult(result, 'success', 'âœ… Saved!');
    cancelEdit();
    await loadProfiles();
  } else {
    showResult(result, 'error', 'âŒ ' + (res.error || 'Save failed'));
  }
}

async function deleteProfile(id) {
  if (!confirm('Delete this business profile?')) return;
  const res = await fetch(`/api/profiles/${id}`, { method: 'DELETE' }).then(r => r.json());
  if (res.success) await loadProfiles();
  else alert(res.error || 'Delete failed');
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active',
      (i === 0 && tab === 'manual') ||
      (i === 1 && tab === 'link') ||
      (i === 2 && tab === 'settings')
    );
  });
  ['manual','link','settings'].forEach(id => {
    document.getElementById('panel-' + id).classList.toggle('active', tab === id);
  });
  if (tab === 'settings') loadProfiles();
}

// â”€â”€ Charge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function chargeCard() {
  const amount = document.getElementById('m-amount').value;
  const name = document.getElementById('m-name').value;
  const note = document.getElementById('m-note').value;
  const email = document.getElementById('m-email').value;
  const zip = document.getElementById('m-zip').value;
  const btn = document.getElementById('btn-charge');
  const result = document.getElementById('result-manual');

  if (!amount || parseFloat(amount) <= 0) { showResult(result, 'error', 'Please enter a valid amount.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Processing...';
  result.style.display = 'none';

  try {
    const tokenResult = await card.tokenize();
    if (tokenResult.status !== 'OK') throw new Error(tokenResult.errors?.map(e => e.message).join(', ') || 'Tokenization failed');

    const payments = Square.payments(appId, locId);
    const verifyResult = await payments.verifyBuyer(tokenResult.token, {
      intent: 'CHARGE', customerInitiated: true, sellerKeyedIn: true,
      amount: parseFloat(amount).toFixed(2), currencyCode: 'USD',
      billingContact: zip ? { postalCode: zip } : undefined,
    });

    const res = await fetch('/api/charge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sourceId: tokenResult.token,
        verificationToken: verifyResult?.token,
        amount, currency: 'USD',
        note: [name, note].filter(Boolean).join(' â€” '),
        buyerEmail: email || undefined,
      }),
    }).then(r => r.json());

    if (res.success) {
      const receipt = res.receiptUrl ? `<br><a href="${res.receiptUrl}" target="_blank">View Receipt</a>` : '';
      showResult(result, 'success', `âœ… Payment successful! ID: ${res.paymentId}${receipt}`);
    } else {
      showResult(result, 'error', 'âŒ ' + (res.errors?.map(e => e.detail).join('<br>') || 'Payment failed'));
    }
  } catch (e) {
    showResult(result, 'error', 'âŒ ' + e.message);
  }

  btn.disabled = false;
  btn.innerHTML = 'Charge';
}

// â”€â”€ Payment Link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createLink() {
  const amount = document.getElementById('l-amount').value;
  const title = document.getElementById('l-title').value || 'Payment';
  const description = document.getElementById('l-desc').value;
  const btn = document.getElementById('btn-link');
  const result = document.getElementById('result-link');

  if (!amount || parseFloat(amount) <= 0) { showResult(result, 'error', 'Please enter a valid amount.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Generating...';
  result.style.display = 'none';

  const res = await fetch('/api/payment-link', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ amount, currency: 'USD', title, description }),
  }).then(r => r.json());

  if (res.success) {
    result.className = 'result success';
    result.style.display = 'block';
    result.innerHTML = `âœ… Link created!
      <div class="link-box">
        <input type="text" id="link-url" value="${res.url}" readonly />
        <button class="btn-copy" onclick="copyLink()">Copy</button>
      </div>`;
  } else {
    showResult(result, 'error', 'âŒ ' + (res.errors?.map(e => e.detail).join('<br>') || 'Failed'));
  }

  btn.disabled = false;
  btn.innerHTML = 'Generate Link';
}

function copyLink() {
  navigator.clipboard.writeText(document.getElementById('link-url').value).then(() => {
    const btn = document.querySelector('.btn-copy');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

function showResult(el, type, msg) {
  el.className = 'result ' + type;
  el.innerHTML = msg;
  el.style.display = 'block';
}

init();
</script>
</body>
</html>
