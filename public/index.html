<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Terminal</title>
  <script src="https://web.squarecdn.com/v1/square.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f4f5f7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      width: 100%;
      max-width: 480px;
      overflow: hidden;
    }
    .header {
      background: #006AFF;
      color: white;
      padding: 24px 28px;
    }
    .header h1 { font-size: 22px; font-weight: 600; }
    .header p { font-size: 13px; opacity: 0.8; margin-top: 4px; }
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab {
      flex: 1;
      padding: 14px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active {
      color: #006AFF;
      border-bottom-color: #006AFF;
    }
    .panel { display: none; padding: 24px 28px; }
    .panel.active { display: block; }
    .field { margin-bottom: 16px; }
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="number"], input[type="email"], select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border 0.2s;
    }
    input:focus, select:focus { border-color: #006AFF; }
    .amount-wrap {
      position: relative;
    }
    .amount-wrap span {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
      font-size: 14px;
    }
    .amount-wrap input { padding-left: 24px; }
    #card-container {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px 12px;
      min-height: 44px;
    }
    .btn {
      width: 100%;
      padding: 13px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 8px;
    }
    .btn-primary { background: #006AFF; color: white; }
    .btn-primary:hover { background: #0057d4; }
    .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }
    .btn-link { background: #10b981; color: white; }
    .btn-link:hover { background: #059669; }
    .btn-link:disabled { background: #6ee7b7; cursor: not-allowed; }
    .result {
      margin-top: 16px;
      padding: 14px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    .result.success { background: #ecfdf5; color: #065f46; border: 1px solid #6ee7b7; }
    .result.error { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }
    .link-box {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .link-box input {
      flex: 1;
      background: #f9fafb;
      font-size: 13px;
    }
    .btn-copy {
      padding: 10px 14px;
      background: #006AFF;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }
    .btn-copy:hover { background: #0057d4; }
    .spinner {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üí≥ Payment Terminal</h1>
    <p>Manual entry or send payment link</p>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('manual')">Manual Entry</div>
    <div class="tab" onclick="switchTab('link')">Payment Link</div>
  </div>

  <!-- MANUAL ENTRY -->
  <div class="panel active" id="panel-manual">
    <div class="field">
      <label>Amount</label>
      <div class="amount-wrap">
        <span>$</span>
        <input type="number" id="m-amount" placeholder="0.00" min="0.01" step="0.01" />
      </div>
    </div>
    <div class="field">
      <label>Customer Name (optional)</label>
      <input type="text" id="m-name" placeholder="John Smith" />
    </div>
    <div class="field">
      <label>Note (optional)</label>
      <input type="text" id="m-note" placeholder="Invoice #123, service description..." />
    </div>
    <div class="field">
      <label>Card</label>
      <div id="card-container"></div>
    </div>
    <button class="btn btn-primary" id="btn-charge" onclick="chargeCard()">Charge</button>
    <div class="result" id="result-manual"></div>
  </div>

  <!-- PAYMENT LINK -->
  <div class="panel" id="panel-link">
    <div class="field">
      <label>Amount</label>
      <div class="amount-wrap">
        <span>$</span>
        <input type="number" id="l-amount" placeholder="0.00" min="0.01" step="0.01" />
      </div>
    </div>
    <div class="field">
      <label>Title (optional)</label>
      <input type="text" id="l-title" placeholder="Payment for services" />
    </div>
    <div class="field">
      <label>Description (optional)</label>
      <input type="text" id="l-desc" placeholder="Additional details..." />
    </div>
    <button class="btn btn-link" id="btn-link" onclick="createLink()">Generate Link</button>
    <div class="result" id="result-link"></div>
  </div>
</div>

<script>
let card;
let appId, locId;

async function init() {
  const cfg = await fetch('/api/config').then(r => r.json());
  appId = cfg.applicationId;
  locId = cfg.locationId;

  const payments = Square.payments(appId, locId);
  card = await payments.card();
  await card.attach('#card-container');
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0 && tab === 'manual') || (i === 1 && tab === 'link'));
  });
  document.getElementById('panel-manual').classList.toggle('active', tab === 'manual');
  document.getElementById('panel-link').classList.toggle('active', tab === 'link');
}

async function chargeCard() {
  const amount = document.getElementById('m-amount').value;
  const name = document.getElementById('m-name').value;
  const note = document.getElementById('m-note').value;
  const btn = document.getElementById('btn-charge');
  const result = document.getElementById('result-manual');

  if (!amount || parseFloat(amount) <= 0) {
    showResult(result, 'error', 'Please enter a valid amount.');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Processing...';
  result.style.display = 'none';

  try {
    const tokenResult = await card.tokenize();
    if (tokenResult.status !== 'OK') {
      throw new Error(tokenResult.errors?.map(e => e.message).join(', ') || 'Card tokenization failed');
    }

    const res = await fetch('/api/charge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sourceId: tokenResult.token,
        amount,
        currency: 'USD',
        note: [name, note].filter(Boolean).join(' ‚Äî '),
      }),
    }).then(r => r.json());

    if (res.success) {
      const receiptLink = res.receiptUrl ? `<br><a href="${res.receiptUrl}" target="_blank">View Receipt</a>` : '';
      showResult(result, 'success', `‚úÖ Payment successful! ID: ${res.paymentId}${receiptLink}`);
    } else {
      const msg = res.errors?.map(e => e.detail).join('<br>') || 'Payment failed';
      showResult(result, 'error', '‚ùå ' + msg);
    }
  } catch (e) {
    showResult(result, 'error', '‚ùå ' + e.message);
  }

  btn.disabled = false;
  btn.innerHTML = 'Charge';
}

async function createLink() {
  const amount = document.getElementById('l-amount').value;
  const title = document.getElementById('l-title').value || 'Payment';
  const description = document.getElementById('l-desc').value;
  const btn = document.getElementById('btn-link');
  const result = document.getElementById('result-link');

  if (!amount || parseFloat(amount) <= 0) {
    showResult(result, 'error', 'Please enter a valid amount.');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Generating...';
  result.style.display = 'none';

  const res = await fetch('/api/payment-link', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ amount, currency: 'USD', title, description }),
  }).then(r => r.json());

  if (res.success) {
    result.className = 'result success';
    result.style.display = 'block';
    result.innerHTML = `‚úÖ Link created!
      <div class="link-box">
        <input type="text" id="link-url" value="${res.url}" readonly />
        <button class="btn-copy" onclick="copyLink()">Copy</button>
      </div>`;
  } else {
    const msg = res.errors?.map(e => e.detail).join('<br>') || 'Failed to create link';
    showResult(result, 'error', '‚ùå ' + msg);
  }

  btn.disabled = false;
  btn.innerHTML = 'Generate Link';
}

function copyLink() {
  const input = document.getElementById('link-url');
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = document.querySelector('.btn-copy');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

function showResult(el, type, msg) {
  el.className = 'result ' + type;
  el.innerHTML = msg;
  el.style.display = 'block';
}

init();
</script>
</body>
</html>
